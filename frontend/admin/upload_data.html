<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Data Dasa Wisma</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500&family=Inter:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Favicons -->
    <link href="../../assets/img/iconfix.png" rel="icon" />
    <link href="../../assets/img/iconfix.png" rel="apple-touch-icon" />

    <!-- Vendor CSS Files -->
    <link
      href="../../assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="../../assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="../../assets/vendor/swiper/swiper-bundle.min.css"
      rel="stylesheet"
    />
    <link
      href="../../assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="../../assets/vendor/aos/aos.css" rel="stylesheet" />

    <!-- Template Main CSS Files -->
    <link href="../../assets/css/variables.css" rel="stylesheet" />
    <link href="../../assets/css/main.css" rel="stylesheet" />
  </head>

  <body>
    <!-- Header -->
    <header id="header" class="header d-flex align-items-center fixed-top">
      <div
        class="container-fluid container-xl d-flex align-items-center justify-content-between"
      >
        <a class="logo d-flex align-items-center">
          <h1>PKK Desa Sidomulyo</h1>
        </a>
        <div
          class="position-relative d-flex align-items-center"
          id="header-right"
        >
          <span id="userEmail" class="me-3"></span>
          <button class="btn btn-outline-primary" id="logoutBtn">Logout</button>
        </div>
      </div>
    </header>

    <main id="main">
      <div class="container mt-5 pt-4">
        <h2>Form Data Dasa Wisma</h2>
        <div class="card">
          <div class="card-body">
            <form id="dasawismaForm">
              <!-- Informasi Dasar -->
              <div class="mb-3">
                <label for="namaDasawisma" class="form-label"
                  >Nama Dasa Wisma:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="namaDasawisma"
                  required
                />
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="jumlahKRT" class="form-label">Jumlah KRT:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="jumlahKRT"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="jumlahKK" class="form-label">Jumlah KK:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="jumlahKK"
                    min="0"
                    required
                  />
                </div>
              </div>

              <!-- Jumlah Anggota Keluarga -->
              <h5 class="mt-4">Jumlah Anggota Keluarga</h5>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Total:</label>
                  <div class="input-group">
                    <span class="input-group-text">L</span>
                    <input
                      type="number"
                      class="form-control"
                      id="totalL"
                      min="0"
                      required
                    />
                    <span class="input-group-text">P</span>
                    <input
                      type="number"
                      class="form-control"
                      id="totalP"
                      min="0"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Balita:</label>
                  <div class="input-group">
                    <span class="input-group-text">L</span>
                    <input
                      type="number"
                      class="form-control"
                      id="balitaL"
                      min="0"
                      required
                    />
                    <span class="input-group-text">P</span>
                    <input
                      type="number"
                      class="form-control"
                      id="balitaP"
                      min="0"
                      required
                    />
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="pus" class="form-label">PUS:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="pus"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="wus" class="form-label">WUS:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="wus"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="ibuHamil" class="form-label">Ibu Hamil:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="ibuHamil"
                    min="0"
                    required
                  />
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="ibuMenyusui" class="form-label"
                    >Ibu Menyusui:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="ibuMenyusui"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="lansia" class="form-label">Lansia:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="lansia"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="buta" class="form-label">Buta:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="buta"
                    min="0"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="berkebutuhanKhusus" class="form-label"
                  >Berkebutuhan Khusus:</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="berkebutuhanKhusus"
                  min="0"
                  required
                />
              </div>

              <!-- Jumlah Rumah -->
              <h5 class="mt-4">Jumlah Rumah</h5>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="rumahSehat" class="form-label">Sehat:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="rumahSehat"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="rumahTidakSehat" class="form-label"
                    >Tidak Sehat:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="rumahTidakSehat"
                    min="0"
                    required
                  />
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="memilikiTempatSampah" class="form-label"
                    >Memiliki Tempat Pembuangan Sampah:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="memilikiTempatSampah"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="memilikiSPAL" class="form-label"
                    >Memiliki SPAL:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="memilikiSPAL"
                    min="0"
                    required
                  />
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="memilikiJamban" class="form-label"
                    >Memiliki Jamban Keluarga:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="memilikiJamban"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="memilikiStikerP4K" class="form-label"
                    >Menempel Stiker P4K:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="memilikiStikerP4K"
                    min="0"
                    required
                  />
                </div>
              </div>

              <!-- Sumber Air -->
              <h5 class="mt-4">Sumber Air Keluarga</h5>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="sumurAir" class="form-label">Sumur:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="sumurAir"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="pdamAir" class="form-label">PDAM:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="pdamAir"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label for="lainnyaAir" class="form-label">Lainnya:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="lainnyaAir"
                    min="0"
                    required
                  />
                </div>
              </div>

              <!-- Makanan Pokok -->
              <h5 class="mt-4">Makanan Pokok</h5>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="makananBeras" class="form-label">Beras:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="makananBeras"
                    min="0"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="makananNonBeras" class="form-label"
                    >Non Beras:</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="makananNonBeras"
                    min="0"
                    required
                  />
                </div>
              </div>

              <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">
                  Simpan Data
                </button>
                <a href="/dashboard" class="btn btn-secondary"
                  >Kembali ke Dashboard</a
                >
              </div>
            </form>
            <div id="status" class="mt-3"></div>
          </div>
        </div>

        <!-- Data Table Section -->
        <div class="container mt-5" id="tableSection">
          <h3>Data Dasa Wisma</h3>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>Nama Dasa Wisma</th>
                  <th>Jumlah KRT</th>
                  <th>Jumlah KK</th>
                  <th>Total L/P</th>
                  <th>Tanggal</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="dasawismaTableBody">
                <!-- Data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" id="editModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Edit Data Dasa Wisma</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div class="modal-body">
                <form id="editForm">
                  <input type="hidden" id="editId" />
                  <div class="mb-3">
                    <label for="editNamaDasawisma" class="form-label"
                      >Nama Dasa Wisma:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="editNamaDasawisma"
                      required
                    />
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="editJumlahKRT" class="form-label">Jumlah KRT:</label>
                      <input type="number" class="form-control" id="editJumlahKRT" min="0" required>
                    </div>
                    <div class="col-md-6">
                      <label for="editJumlahKK" class="form-label">Jumlah KK:</label>
                      <input type="number" class="form-control" id="editJumlahKK" min="0" required>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Total L:</label>
                      <input type="number" class="form-control" id="editTotalL" min="0" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Total P:</label>
                      <input type="number" class="form-control" id="editTotalP" min="0" required>
                    </div>
                  </div>
                  <!-- Add more edit fields if needed -->
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveEdit">Simpan Perubahan</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Vendor JS Files -->
    <script src="../../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="../../assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="../../assets/vendor/aos/aos.js"></script>

    <!-- Template Main JS File -->
    <script src="../../assets/js/main.js"></script>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        deleteDoc,
        doc,
        updateDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAOluooURyiYp6R-4BWdLwZNs9f3VZreaY",
        authDomain: "pkkdesasidomulyo.firebaseapp.com",
        projectId: "pkkdesasidomulyo",
        storageBucket: "pkkdesasidomulyo.firebasestorage.com",
        messagingSenderId: "647872499017",
        appId: "1:647872499017:web:6a12f09da5018a0c769e98",
        measurementId: "G-0T78MDY5ED",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let currentUser = null;

      // Initialize modal
      const editModal = new bootstrap.Modal(document.getElementById("editModal"));

      // Check authentication state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          document.getElementById("userEmail").textContent = user.email;
          loadData(); // Load data when user is authenticated
        } else {
          window.location.href = "/login";
        }
      });

      // Logout handler
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        try {
          await signOut(auth);
          window.location.href = "/login";
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Gagal logout. Silakan coba lagi.");
        }
      });

      // Helper function to get form value
      const getFormValue = (id) => {
        const value = document.getElementById(id).value.trim();
        return value === "" ? "-" : value;
      };

      // Function to load and display data
      async function loadData() {
        const tableBody = document.getElementById("dasawismaTableBody");
        tableBody.innerHTML = "";

        try {
          const querySnapshot = await getDocs(collection(db, "dasawisma"));
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${data.namaDasawisma}</td>
              <td>${data.jumlahKRT}</td>
              <td>${data.jumlahKK}</td>
              <td>${data.totalL}/${data.totalP}</td>
              <td>${data.tanggal}</td>
              <td>
                <button class="btn btn-sm btn-primary edit-btn" data-id="${doc.id}">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${doc.id}">
                  <i class="bi bi-trash"></i> Hapus
                </button>
              </td>
            `;

            // Add edit button handler
            row.querySelector(".edit-btn").addEventListener("click", () => {
              document.getElementById("editId").value = doc.id;
              document.getElementById("editNamaDasawisma").value = data.namaDasawisma;
              document.getElementById("editJumlahKRT").value = data.jumlahKRT;
              document.getElementById("editJumlahKK").value = data.jumlahKK;
              document.getElementById("editTotalL").value = data.totalL;
              document.getElementById("editTotalP").value = data.totalP;
              editModal.show();
            });

            // Add delete button handler
            row.querySelector(".delete-btn").addEventListener("click", async () => {
              if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
                try {
                  await deleteDoc(doc(db, "dasawisma", doc.id));
                  loadData();
                  alert("Data berhasil dihapus");
                } catch (error) {
                  console.error("Error deleting document:", error);
                  alert("Gagal menghapus data");
                }
              }
            });

            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error loading data:", error);
          alert("Gagal memuat data");
        }
      }

      // Handle save edit
      document.getElementById("saveEdit").addEventListener("click", async () => {
        const docId = document.getElementById("editId").value;
        const docRef = doc(db, "dasawisma", docId);

        try {
          await updateDoc(docRef, {
            namaDasawisma: document.getElementById("editNamaDasawisma").value,
            jumlahKRT: document.getElementById("editJumlahKRT").value,
            jumlahKK: document.getElementById("editJumlahKK").value,
            totalL: document.getElementById("editTotalL").value,
            totalP: document.getElementById("editTotalP").value,
          });

          editModal.hide();
          loadData();
          alert("Data berhasil diperbarui");
        } catch (error) {
          console.error("Error updating document:", error);
          alert("Gagal memperbarui data");
        }
      });

      // Form submit handler
      const dasawismaForm = document.getElementById("dasawismaForm");
      const statusDiv = document.getElementById("status");

      dasawismaForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentUser) {
          statusDiv.innerHTML = '<div class="alert alert-danger">Anda harus login untuk menyimpan data</div>';
          return;
        }

        const submitButton = dasawismaForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        statusDiv.innerHTML = '<div class="alert alert-info">Menyimpan data...</div>';

        try {
          const data = {
            namaDasawisma: getFormValue("namaDasawisma"),
            jumlahKRT: getFormValue("jumlahKRT"),
            jumlahKK: getFormValue("jumlahKK"),
            totalL: getFormValue("totalL"),
            totalP: getFormValue("totalP"),
            balitaL: getFormValue("balitaL"),
            balitaP: getFormValue("balitaP"),
            pus: getFormValue("pus"),
            wus: getFormValue("wus"),
            ibuHamil: getFormValue("ibuHamil"),
            ibuMenyusui: getFormValue("ibuMenyusui"),
            lansia: getFormValue("lansia"),
            buta: getFormValue("buta"),
            berkebutuhanKhusus: getFormValue("berkebutuhanKhusus"),
            rumahSehat: getFormValue("rumahSehat"),
            rumahTidakSehat: getFormValue("rumahTidakSehat"),
            memilikiTempatSampah: getFormValue("memilikiTempatSampah"),
            memilikiSPAL: getFormValue("memilikiSPAL"),
            memilikiJamban: getFormValue("memilikiJamban"),
            memilikiStikerP4K: getFormValue("memilikiStikerP4K"),
            sumurAir: getFormValue("sumurAir"),
            pdamAir: getFormValue("pdamAir"),
            lainnyaAir: getFormValue("lainnyaAir"),
            makananBeras: getFormValue("makananBeras"),
            makananNonBeras: getFormValue("makananNonBeras"),
            timestamp: serverTimestamp(),
            authorEmail: currentUser.email,
            createdAt: new Date().toISOString(),
            tanggal: new Date().toLocaleDateString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
            }),
          };

          await addDoc(collection(db, "dasawisma"), data);
          statusDiv.innerHTML = '<div class="alert alert-success">Data berhasil disimpan!</div>';
          dasawismaForm.reset();
          loadData();

          // Optional: Redirect to dashboard after successful submission
          setTimeout(() => {
            window.location.href = "/dashboard";
          }, 2000);
        } catch (error) {
          console.error("Error saving data:", error);
          statusDiv.innerHTML = `<div class="alert alert-danger">Gagal menyimpan data: ${error.message}</div>`;
        } finally {
          submitButton.disabled = false;
        }
      });
    </script>
  </body>
</html>